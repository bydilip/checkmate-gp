<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Checkmate GP ‚Äî Racing Edition</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Barlow+Condensed:wght@300;400;500;600;700&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{--gold:#D4AF37;--gold-dim:#9A7B2C;--gold-glow:#F5D060;--black:#000;--black-mid:#0A0A0A;--black-light:#161616;--border:#222;--white-hot:#FFF;--silver:#999;--silver-dim:#555;--green:#00E676}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Barlow',sans-serif;background:var(--black);color:var(--white-hot);min-height:100vh;display:flex;flex-direction:column;align-items:center;overflow-x:hidden;user-select:none}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 1px,rgba(255,255,255,.018) 1px,rgba(255,255,255,.018) 2px),repeating-linear-gradient(-45deg,transparent,transparent 1px,rgba(255,255,255,.012) 1px,rgba(255,255,255,.012) 2px);pointer-events:none;z-index:0}
body::after{content:'';position:fixed;top:-150px;left:50%;transform:translateX(-50%);width:500px;height:300px;background:radial-gradient(ellipse,rgba(212,175,55,.07),transparent 70%);pointer-events:none;z-index:0}
.app{width:100%;max-width:480px;position:relative;z-index:1}
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 6px}
.logo-area{display:flex;align-items:center;gap:10px}
.shield{width:38px;height:38px;background:linear-gradient(135deg,var(--gold),var(--gold-dim));border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 12px rgba(212,175,55,.25)}
.shield::after{content:'‚ôû';font-size:22px;color:var(--black)}
.logo-text{font-family:'Orbitron',monospace;font-weight:800;font-size:18px;letter-spacing:2px;color:var(--gold);text-shadow:0 0 30px rgba(212,175,55,.25);line-height:1}
.logo-sub{font-family:'Barlow Condensed',sans-serif;font-size:9px;letter-spacing:5px;color:var(--silver-dim);text-transform:uppercase;margin-top:2px}
.btn-icon{background:var(--black-mid);border:1px solid var(--border);color:var(--silver-dim);width:38px;height:38px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all .2s}
.btn-icon:active{border-color:var(--gold);color:var(--gold)}
.engine-status{text-align:center;padding:2px 16px 4px;font-family:'Orbitron',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;transition:opacity .5s}
.engine-status.loading{color:var(--gold)}.engine-status.ready{color:var(--green)}.engine-status.fallback{color:var(--gold)}
.edot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;vertical-align:middle}
.engine-status.loading .edot{background:var(--gold);animation:blink 1s infinite}.engine-status.ready .edot{background:var(--green)}.engine-status.fallback .edot{background:var(--gold)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.player-panel{display:flex;align-items:center;padding:10px 10px;gap:10px;transition:all .3s;margin:0 8px;background:linear-gradient(135deg,rgba(255,255,255,.025),rgba(255,255,255,.008));border:1px solid rgba(255,255,255,.04);position:relative;overflow:hidden}
.player-panel::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 2px,rgba(255,255,255,.012) 2px,rgba(255,255,255,.012) 3px);pointer-events:none}
.black-panel{border-bottom:none}.white-panel{border-top:none}
.player-avatar{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;border:2px solid var(--border);transition:all .3s;flex-shrink:0;background:var(--black-mid)}
.player-panel.active .player-avatar{border-color:var(--gold);box-shadow:0 0 14px rgba(212,175,55,.25)}
.player-info{flex:1;min-width:0}
.player-name{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--white-hot)}
.player-rating{font-family:'Orbitron',monospace;font-size:10px;color:var(--silver-dim);margin-top:1px;letter-spacing:1px}
.player-captures{display:flex;flex-wrap:wrap;gap:1px;margin-top:3px;min-height:16px;align-items:center}
.cap-piece{width:14px;height:14px;display:inline-flex;align-items:center;justify-content:center}.cap-piece svg{width:100%;height:100%}
.clock{font-family:'Orbitron',monospace;font-size:20px;font-weight:700;color:var(--silver);background:var(--black);border:1px solid var(--border);border-radius:8px;padding:5px 12px;min-width:80px;text-align:center;transition:all .3s;letter-spacing:2px}
.player-panel.active .clock{color:var(--gold);border-color:var(--gold-dim);box-shadow:0 0 12px rgba(212,175,55,.12)}
.clock.urgent{color:#FF4444!important;border-color:#FF4444!important;animation:pc .8s infinite}
@keyframes pc{0%,100%{opacity:1}50%{opacity:.5}}
.racing-stripe{display:none}
.board-wrapper{width:100%;padding:0 8px;box-sizing:border-box}
.board-container{width:100%;aspect-ratio:1/1;position:relative;overflow:hidden}
@supports not (aspect-ratio:1/1){.board-container{padding-top:100%;}}
.board{position:absolute;top:0;left:0;right:0;bottom:0;display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr)}
.square{position:relative;display:flex;align-items:center;justify-content:center;cursor:pointer}
.square.light{background:linear-gradient(135deg,#D9CBAA,#C8B890)}
.square.dark{background:linear-gradient(135deg,#302820,#1E1812)}
.square.selected.light{background:linear-gradient(135deg,#F5D060,#E8C040)}.square.selected.dark{background:linear-gradient(135deg,#6B5A20,#504010)}
.square.last-move.light{background:linear-gradient(135deg,#E8D080,#D4BC60)}.square.last-move.dark{background:linear-gradient(135deg,#3A3018,#2A2010)}
.square.check-king.light{background:linear-gradient(135deg,#FF5555,#DD3333)}.square.check-king.dark{background:linear-gradient(135deg,#992222,#771111)}
.rank-label,.file-label{position:absolute;font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:600;pointer-events:none;opacity:.5}
.rank-label{top:2px;left:3px}.file-label{bottom:1px;right:3px}
.square.light .rank-label,.square.light .file-label{color:#8B7B60}
.square.dark .rank-label,.square.dark .file-label{color:#7B6B50}
.move-dot{position:absolute;width:28%;height:28%;border-radius:50%;background:rgba(212,175,55,.4);pointer-events:none;animation:di .15s ease-out;box-shadow:0 0 6px rgba(212,175,55,.15)}
.move-ring{position:absolute;width:88%;height:88%;border-radius:50%;border:4px solid rgba(212,175,55,.45);pointer-events:none;animation:di .15s ease-out}
@keyframes di{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
.piece{position:relative;z-index:2;width:82%;height:82%;display:flex;align-items:center;justify-content:center;pointer-events:none;filter:drop-shadow(0 2px 2px rgba(0,0,0,.4))}
.piece svg{width:100%;height:100%;display:block}.square.selected .piece{transform:scale(1.1);filter:drop-shadow(0 2px 2px rgba(0,0,0,.4)) drop-shadow(0 0 6px rgba(212,175,55,.3))}
.anim-piece{position:absolute;z-index:10;pointer-events:none;filter:drop-shadow(0 4px 8px rgba(0,0,0,.6));transition:left .18s cubic-bezier(.22,.61,.36,1),top .18s cubic-bezier(.22,.61,.36,1)}
.status-bar{width:100%;padding:8px 16px;display:flex;align-items:center;justify-content:center;min-height:40px}
.status-text{font-family:'Barlow Condensed',sans-serif;font-size:13px;letter-spacing:3px;text-transform:uppercase;color:var(--silver-dim)}
.status-badge{font-family:'Orbitron',monospace;background:var(--gold);color:var(--black);font-size:10px;font-weight:700;letter-spacing:2px;padding:5px 16px;border-radius:4px;text-transform:uppercase;animation:bp .3s cubic-bezier(.34,1.56,.64,1)}
.status-badge.check{background:#FF4444;color:#fff}.status-badge.thinking{background:var(--black-mid);border:1px solid var(--gold-dim);color:var(--gold)}
@keyframes bp{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
.controls{width:100%;padding:4px 16px 12px;display:flex;gap:8px}
.btn{flex:1;background:var(--black-mid);border:1px solid var(--border);color:var(--silver-dim);font-family:'Barlow Condensed',sans-serif;font-size:11px;letter-spacing:2px;text-transform:uppercase;font-weight:600;padding:10px 6px;border-radius:8px;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:3px}
.btn:active{border-color:var(--gold);color:var(--gold);background:rgba(212,175,55,.06)}
.btn .be{font-size:16px}
.btn.primary{background:linear-gradient(135deg,var(--gold),var(--gold-dim));border-color:var(--gold-dim);color:var(--black);font-weight:700;box-shadow:0 4px 16px rgba(212,175,55,.15)}.btn.primary:active{background:var(--gold-dim)}
.history-panel{width:100%;padding:0 16px 16px}
.history-label{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:4px;color:var(--silver-dim);text-transform:uppercase;margin-bottom:6px}
.history-scroll{display:flex;gap:4px;overflow-x:auto;padding-bottom:6px;scrollbar-width:none}.history-scroll::-webkit-scrollbar{display:none}
.move-chip{background:var(--black-mid);border:1px solid var(--border);border-radius:4px;padding:4px 10px;font-family:'Barlow Condensed',sans-serif;font-size:12px;color:var(--silver-dim);white-space:nowrap;flex-shrink:0;letter-spacing:1px}
.move-chip.latest{border-color:var(--gold-dim);color:var(--gold);background:rgba(212,175,55,.04)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.95);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(8px);padding:20px}
.modal{background:var(--black-mid);border:1px solid var(--border);border-top:2px solid var(--gold);border-radius:12px;padding:28px 22px;width:100%;max-width:360px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.9);animation:mu .3s cubic-bezier(.34,1.56,.64,1)}
@keyframes mu{from{transform:translateY(40px) scale(.9);opacity:0}to{transform:none;opacity:1}}
.modal-icon{font-size:48px;margin-bottom:10px}
.modal-title{font-family:'Orbitron',monospace;font-size:22px;font-weight:800;color:var(--gold);margin-bottom:6px;letter-spacing:2px}
.modal-sub{font-family:'Barlow Condensed',sans-serif;font-size:13px;color:var(--silver-dim);letter-spacing:2px;margin-bottom:20px;text-transform:uppercase}
.modal-btns{display:flex;flex-direction:column;gap:8px}
.modal-btn{padding:13px;border-radius:8px;font-family:'Barlow Condensed',sans-serif;font-size:13px;letter-spacing:3px;font-weight:700;cursor:pointer;border:none;transition:all .2s;text-transform:uppercase}
.modal-btn.primary{background:linear-gradient(135deg,var(--gold),var(--gold-dim));color:var(--black);box-shadow:0 4px 16px rgba(212,175,55,.15)}.modal-btn.primary:active{background:var(--gold-dim)}
.modal-btn.secondary{background:transparent;border:1px solid var(--border);color:var(--silver-dim)}.modal-btn.secondary:active{border-color:var(--gold);color:var(--gold)}
.setting-group{text-align:left;margin-bottom:16px}
.setting-label{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:3px;color:var(--silver-dim);text-transform:uppercase;margin-bottom:8px}
.elo-grid{display:none}
.elo-btn{display:none}
.elo-btn.active{display:none}
.elo-btn:active{display:none}
.dial-wrap{display:flex;flex-direction:column;align-items:center;gap:4px}
.dial-gauge{position:relative;width:220px;height:145px;touch-action:none;cursor:pointer}
.dial-track{position:absolute;inset:0}
.dial-track svg{width:100%;height:100%}
.dial-needle{position:absolute;left:50%;bottom:calc(30/130 * 100%);width:3px;height:65px;transform-origin:bottom center;background:var(--gold);border-radius:2px;margin-left:-1.5px;transition:transform 0.05s linear;pointer-events:none}
.dial-knob{position:absolute;width:20px;height:20px;border-radius:50%;background:var(--gold);border:2px solid #000;top:-10px;left:50%;margin-left:-10px;box-shadow:0 2px 6px rgba(0,0,0,.5);pointer-events:none}
.dial-knob::after{content:'';position:absolute;width:6px;height:6px;border-radius:50%;background:#000;top:50%;left:50%;transform:translate(-50%,-50%)}
.dial-hub{position:absolute;left:50%;bottom:calc(30/130 * 100%);width:10px;height:10px;margin-left:-5px;margin-bottom:-5px;border-radius:50%;background:#333;border:1.5px solid var(--gold);pointer-events:none;z-index:2}
.dial-value{font-family:'Orbitron',monospace;font-size:28px;font-weight:800;color:var(--gold);text-align:center;letter-spacing:2px;margin-top:8px}
.dial-label{font-family:'Barlow Condensed',sans-serif;font-size:11px;color:var(--silver-dim);letter-spacing:3px;text-transform:uppercase;text-align:center}
.dial-controls{display:flex;align-items:center;gap:12px;margin-top:6px}
.dial-btn{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:var(--black);color:var(--silver);font-size:20px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:'Orbitron',monospace}
.dial-btn:active{border-color:var(--gold);color:var(--gold);background:rgba(212,175,55,.08);transform:scale(.92)}
.dial-range{display:flex;justify-content:space-between;width:200px}
.dial-range span{font-family:'Orbitron',monospace;font-size:8px;color:var(--silver-dim);letter-spacing:1px}
.dial-hint{font-family:'Barlow Condensed',sans-serif;font-size:9px;color:var(--silver-dim);letter-spacing:2px;text-transform:uppercase;opacity:.5;margin-top:2px}
.mode-row{display:flex;gap:8px;margin-bottom:12px}
.mode-btn{flex:1;padding:14px 8px;border-radius:8px;font-family:'Barlow Condensed',sans-serif;font-size:12px;letter-spacing:2px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--black);color:var(--silver-dim);transition:all .2s;text-transform:uppercase;text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px}
.mode-btn .mode-icon{font-size:22px}.mode-btn.active{border-color:var(--gold-dim);color:var(--white-hot);background:rgba(212,175,55,.06)}
.promo-pieces{display:flex;justify-content:center;gap:10px;margin:14px 0}
.promo-piece{width:60px;height:60px;cursor:pointer;background:var(--black);border:1px solid var(--border);border-radius:10px;padding:8px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.promo-piece:active{transform:scale(1.1);border-color:var(--gold)}.promo-piece svg{width:100%;height:100%}
.replay-bar{width:100%;padding:8px 16px;display:flex;flex-direction:column;align-items:center;gap:6px}
.replay-info{font-family:'Barlow Condensed',sans-serif;font-size:11px;color:var(--silver-dim);letter-spacing:1px;text-align:center;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.replay-controls{display:flex;gap:6px;align-items:center}
.replay-btn{width:42px;height:42px;border-radius:50%;border:1px solid var(--border);background:var(--black);color:var(--silver);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.replay-btn:active{border-color:var(--gold);color:var(--gold);background:rgba(212,175,55,.08);transform:scale(.9)}
.replay-btn.active{border-color:var(--gold);color:var(--gold);background:rgba(212,175,55,.12)}
.replay-move-label{font-family:'Orbitron',monospace;font-size:11px;color:var(--gold);letter-spacing:2px;text-align:center}
.replay-exit{background:none;border:1px solid var(--border);color:var(--silver-dim);font-family:'Barlow Condensed',sans-serif;font-size:11px;letter-spacing:2px;padding:6px 16px;border-radius:6px;cursor:pointer;text-transform:uppercase;margin-top:2px}
.replay-exit:active{border-color:var(--gold);color:var(--gold)}
.pgn-textarea{width:100%;height:120px;background:var(--black);border:1px solid var(--border);border-radius:8px;color:var(--white-hot);font-family:'Barlow',sans-serif;font-size:12px;padding:10px;resize:none;margin:8px 0}
.pgn-textarea:focus{outline:none;border-color:var(--gold)}
.pgn-or{font-family:'Barlow Condensed',sans-serif;font-size:11px;color:var(--silver-dim);letter-spacing:2px;text-transform:uppercase;margin:6px 0}
.pgn-file-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;border-radius:8px;border:1px dashed var(--border);color:var(--silver-dim);font-family:'Barlow Condensed',sans-serif;font-size:12px;letter-spacing:2px;cursor:pointer;text-transform:uppercase;transition:all .2s;width:100%}
.pgn-file-btn:active{border-color:var(--gold);color:var(--gold)}
.footer{width:100%;padding:10px 16px 20px;text-align:center}
.footer-text{font-family:'Orbitron',monospace;font-size:7px;letter-spacing:4px;color:var(--silver-dim);text-transform:uppercase;opacity:.35}
.checkered-bar{display:none}
</style>
</head>
<body>
<div class="app">
<div class="header">
  <div class="logo-area"><div class="shield"></div><div><div class="logo-text">CHECKMATE GP</div><div class="logo-sub">Racing Edition</div></div></div>
  <div style="display:flex;gap:6px"><div class="btn-icon" onclick="showPGNUpload()">üìã</div><div class="btn-icon" onclick="showSettings()">‚öô</div></div>
</div>
<div class="engine-status loading" id="engine-status"><span class="edot"></span>Loading Stockfish Engine...</div>
<div class="player-panel black-panel" id="panel-black">
  <div class="player-avatar" id="avatar-black">üèéÔ∏è</div>
  <div class="player-info"><div class="player-name" id="name-black">STOCKFISH</div><div class="player-rating" id="rating-black">ELO 1000</div><div class="player-captures" id="captures-black"></div></div>
  <div class="clock" id="clock-black">10:00</div>
</div>
<div class="racing-stripe" id="stripe-top"></div>
<div class="board-wrapper"><div class="board-container"><div class="board" id="board"></div></div></div>
<div class="racing-stripe" id="stripe-bottom"></div>
<div class="player-panel white-panel active" id="panel-white">
  <div class="player-avatar" id="avatar-white">üèÅ</div>
  <div class="player-info"><div class="player-name" id="name-white">DRIVER</div><div class="player-rating" id="rating-white"></div><div class="player-captures" id="captures-white"></div></div>
  <div class="clock" id="clock-white">10:00</div>
</div>
<div class="status-bar" id="status-bar"><div class="status-text">Lights out ‚Äî White to move</div></div>
<div class="replay-bar" id="replay-bar" style="display:none">
  <div class="replay-info" id="replay-info"></div>
  <div class="replay-controls">
    <button class="replay-btn" onclick="replayGo(0)">‚èÆ</button>
    <button class="replay-btn" onclick="replayStep(-1)">‚óÄ</button>
    <button class="replay-btn" onclick="replayToggleAuto()" id="replay-auto-btn">‚ñ∂</button>
    <button class="replay-btn" onclick="replayStep(1)">‚ñ∂</button>
    <button class="replay-btn" onclick="replayGo(9999)">‚è≠</button>
  </div>
  <div class="replay-move-label" id="replay-move-label">Start Position</div>
  <button class="replay-exit" onclick="exitReplay()">‚úï Exit Replay</button>
</div>
<div class="controls" id="game-controls">
  <button class="btn" onclick="undoMove()"><span class="be">‚Ü©</span>Undo</button>
  <button class="btn primary" onclick="newGame()"><span class="be">üèÅ</span>Race</button>
  <button class="btn" onclick="flipBoard()"><span class="be">üîÑ</span>Flip</button>
</div>
<div class="history-panel"><div class="history-label">Lap History</div><div class="history-scroll" id="move-history"></div></div>
<div class="footer"><div class="checkered-bar"></div><div class="footer-text">Checkmate GP ¬∑ Powered by Stockfish</div></div>
</div>
<div class="modal-overlay" id="modal-overlay" style="display:none"><div class="modal">
  <div class="modal-icon" id="modal-icon">üèÅ</div><div class="modal-title" id="modal-title">Settings</div>
  <div class="modal-sub" id="modal-sub"></div><div class="modal-btns" id="modal-btns"></div>
</div></div>

<script>
// ‚ïê‚ïê‚ïê SVG PIECES ‚ïê‚ïê‚ïê
const PATHS={P:'<path d="M22.5 9c-2.21 0-4 1.79-4 4 0 .89.29 1.71.78 2.38C17.33 16.5 16 18.35 16 20.5c0 1.12.42 2.14 1.1 2.92C14.62 24.69 13 26.92 13 29.5c0 .93.23 1.8.62 2.57C12.22 33.1 11 34.75 11 36.5c0 3.04 5.15 5.5 11.5 5.5s11.5-2.46 11.5-5.5c0-1.75-1.22-3.4-3.62-4.43.39-.77.62-1.64.62-2.57 0-2.58-1.62-4.81-4.1-6.08.68-.78 1.1-1.8 1.1-2.92 0-2.15-1.33-4-3.28-5.12.49-.67.78-1.49.78-2.38 0-2.21-1.79-4-4-4z"/>',R:'<path d="M9 39h27v-3H9v3zm3-3v-5h21v5H12zm-1-22V9h4v2h5V9h5v2h5V9h4v5l-4 4H15l-4-4zm1 4h21v13H12V18z"/>',N:'<path d="M22 10c10.5 1 16.5 8 16 29H15c0-9 10-6.5 8-21M24 18c.38 2.91-5.55 7.37-8 9-3 2-2.82 4.34-5 4-1.042-.94 1.41-3.04 0-3-1 0 .19 1.23-1 2-1 0-4.003 1-4-4 0-2 6-12 6-12s1.89-1.9 2-3.5c-.73-.994-.5-2-.5-3 1-1 3 2.5 3 2.5h2s.78-1.992 2.5-3c1 0 1 0 1 1v2.5l1 1z"/>',B:'<path d="M9 36c3.39-.97 10.11.43 13.5-2 3.39 2.43 10.11 1.03 13.5 2 0 0 1.65.54 3 2-.68.97-1.65.99-3 .5-3.39-.97-10.11.46-13.5-1-3.39 1.46-10.11.03-13.5 1-1.354.49-2.323.47-3-.5 1.354-1.94 3-2 3-2zM15.5 32c2.5 2.5 12.5 2.5 15 0 .5-1.5 0-2 0-2 0-2.5-2.5-4-2.5-4 5.5-1.5 6-11.5-5-15.5-11 4-10.5 14-5 15.5 0 0-2.5 1.5-2.5 4 0 0-.5.5 0 2z"/><circle cx="22.5" cy="8" r="2.5"/>'};
function mkSVG(t,w){
  const fill=w?'#ffffff':'#000000';
  const stroke=w?'#000000':'#ffffff';
  const sw=w?1.5:1;
  if(t==='K'){
    // King: BIG chunky cross on top, tall narrow body, clearly different from queen
    return`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
      <g style="fill:${fill};stroke:${stroke};stroke-width:${sw};stroke-linecap:round;stroke-linejoin:round">
        <path d="M9 39h27v-3H9z"/>
        <path d="M12.5 36v-3.5h20v3.5z"/>
        <path d="M12 32.5c-.5-4.5.5-7.5 2-9.5 1-1.5 3-2.5 8.5-2.5s7.5 1 8.5 2.5c1.5 2 2.5 5 2 9.5z"/>
        <path d="M14 29.5c0 0 3.5-1.5 8.5-1.5s8.5 1.5 8.5 1.5" style="fill:none"/>
        <path d="M14 31.5c0 0 3.5 1 8.5 1s8.5-1 8.5-1" style="fill:none"/>
        <rect x="20" y="3" width="5" height="14" rx="1.5" ry="1.5"/>
        <rect x="15" y="6.5" width="15" height="5" rx="1.5" ry="1.5"/>
      </g>
    </svg>`;
  }
  if(t==='Q'){
    // Queen: 5-pointed crown with balls on tips, solid body, base with bands  
    return`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45">
      <g style="fill:${fill};stroke:${stroke};stroke-width:${sw};stroke-linecap:round;stroke-linejoin:round">
        <path d="M9 39h27v-3H9z"/>
        <path d="M12 36v-4h21v4z"/>
        <path d="M12.5 32L8 14l7.5 8 7-10 7 10L37 14l-4.5 18z"/>
        <path d="M14 29.5c0 0 3.5-1.5 8.5-1.5s8.5 1.5 8.5 1.5" style="fill:none"/>
        <path d="M14 31.5c0 0 3.5 1 8.5 1s8.5-1 8.5-1" style="fill:none"/>
        <circle cx="8" cy="12" r="3"/>
        <circle cx="15.5" cy="8" r="3"/>
        <circle cx="22.5" cy="5.5" r="3"/>
        <circle cx="29.5" cy="8" r="3"/>
        <circle cx="37" cy="12" r="3"/>
      </g>
    </svg>`;
  }
  return`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 45 45"><g style="fill:${fill};stroke:${stroke};stroke-width:${sw};stroke-linecap:round;stroke-linejoin:round">${PATHS[t]}</g></svg>`;
}
const SVG={};['P','R','N','B','Q','K'].forEach(t=>{SVG['w'+t]=mkSVG(t,true);SVG['b'+t]=mkSVG(t,false);});

// ‚ïê‚ïê‚ïê STOCKFISH ENGINE (loads via Blob Worker on real servers) ‚ïê‚ïê‚ïê
let sf=null,sfOk=false,sfCb=null,useFB=false;
function initSF(){
  const el=document.getElementById('engine-status');
  const sfURL='https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js';
  el.className='engine-status loading';
  el.innerHTML='<span class="edot"></span>Loading Stockfish...';
  function wireUp(worker){
    sf=worker;
    sf.onmessage=function(e){
      const l=typeof e.data==='string'?e.data:'';
      if(l==='uciok'){el.innerHTML='<span class="edot"></span>Initializing...';sf.postMessage('isready');}
      else if(l==='readyok'){sfOk=true;el.className='engine-status ready';el.innerHTML='<span class="edot"></span>Stockfish Ready';setTimeout(()=>el.style.opacity='0',2500);updPanel();}
      else if(l.startsWith('bestmove')){const m=l.split(' ')[1];if(sfCb&&m&&m!=='(none)'){sfCb(m);sfCb=null;}}
    };
    sf.onerror=function(){goFB();};
    sf.postMessage('uci');
  }
  function goFB(){useFB=true;el.className='engine-status ready';el.innerHTML='<span class="edot"></span>Engine Ready';setTimeout(()=>el.style.opacity='0',2500);updPanel();}
  // Fetch with progress indicator
  const xhr=new XMLHttpRequest();
  xhr.open('GET',sfURL);
  xhr.onprogress=function(e){if(e.lengthComputable){const pct=Math.round(e.loaded/e.total*100);el.innerHTML=`<span class="edot"></span>Loading Stockfish ${pct}%`;}};
  xhr.onload=function(){
    if(xhr.status===200){
      try{const blob=new Blob([xhr.responseText],{type:'application/javascript'});wireUp(new Worker(URL.createObjectURL(blob)));}
      catch(e){try{wireUp(new Worker(sfURL));}catch(e2){goFB();}}
    }else{goFB();}
  };
  xhr.onerror=function(){try{wireUp(new Worker(sfURL));}catch(e){goFB();}};
  xhr.send();
}
function cfgSF(elo){if(!sf||!sfOk)return;sf.postMessage('stop');sf.postMessage('setoption name UCI_LimitStrength value true');sf.postMessage('setoption name UCI_Elo value '+elo);sf.postMessage('setoption name Skill Level value '+Math.max(0,Math.floor((elo-800)/50)));}
function askSF(fen){return new Promise(r=>{if(!sf||!sfOk){r(null);return;}sfCb=r;sf.postMessage('position fen '+fen);const mt=aiElo<=500?300:aiElo<=1000?500:aiElo<=1500?800:aiElo<=2000?1200:1500;sf.postMessage('go movetime '+mt);setTimeout(()=>{if(sfCb===r){sfCb=null;sf.postMessage('stop');r(null);}},mt+2000);});}

// ‚ïê‚ïê‚ïê FEN (for Stockfish) ‚ïê‚ïê‚ïê
function toFEN(){let f='';for(let r=0;r<8;r++){let e=0;for(let c=0;c<8;c++){const p=board[r][c];if(!p)e++;else{if(e){f+=e;e=0;}f+=p[0]==='w'?p[1]:p[1].toLowerCase();}}if(e)f+=e;if(r<7)f+='/';}f+=' '+(turn==='w'?'w':'b')+' ';let cs='';if(cast.wK)cs+='K';if(cast.wQ)cs+='Q';if(cast.bK)cs+='k';if(cast.bQ)cs+='q';f+=(cs||'-')+' ';if(epT)f+='abcdefgh'[epT[1]]+'87654321'[epT[0]];else f+='-';f+=' '+fm+' '+(Math.floor(mc/2)+1);return f;}

// ‚ïê‚ïê‚ïê UCI ‚Üí internal move ‚ïê‚ïê‚ïê
function uci2mv(u){if(!u||u.length<4)return null;const F='abcdefgh',fc=F.indexOf(u[0]),fr=8-parseInt(u[1]),tc=F.indexOf(u[2]),tr=8-parseInt(u[3]),pr=u.length>4?u[4].toUpperCase():null;const ms=lM(fr,fc,board);for(const m of ms){if(m.to[0]===tr&&m.to[1]===tc){if(m.promotion)return{...m,_pr:pr||'Q'};return m;}}return null;}

// ‚ïê‚ïê‚ïê GAME STATE ‚ïê‚ïê‚ïê
const VALS={P:100,R:500,B:320,N:300,Q:900,K:0};
const PST={P:[[0,0,0,0,0,0,0,0],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,25,25,10,5,5],[0,0,0,20,20,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-20,-20,10,10,5],[0,0,0,0,0,0,0,0]],N:[[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,0,0,0,-20,-40],[-30,0,10,15,15,10,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,10,15,15,10,5,-30],[-40,-20,0,5,5,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]],B:[[-20,-10,-10,-10,-10,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,10,10,5,0,-10],[-10,5,5,10,10,5,5,-10],[-10,0,10,10,10,10,0,-10],[-10,10,10,10,10,10,10,-10],[-10,5,0,0,0,0,5,-10],[-20,-10,-10,-10,-10,-10,-10,-20]],R:[[0,0,0,0,0,0,0,0],[5,10,10,10,10,10,10,5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[0,0,0,5,5,0,0,0]],Q:[[-20,-10,-10,-5,-5,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,5,5,5,0,-10],[-5,0,5,5,5,5,0,-5],[0,0,5,5,5,5,0,-5],[-10,5,5,5,5,5,0,-10],[-10,0,5,0,0,0,0,-10],[-20,-10,-10,-5,-5,-10,-10,-20]],K:[[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-20,-30,-30,-40,-40,-30,-30,-20],[-10,-20,-20,-20,-20,-20,-20,-10],[20,20,0,0,0,0,20,20],[20,30,10,0,0,10,30,20]]};
let board=[],turn='w',sel=null,vMoves=[],lastMv=null,gameOver=false,flipped=false,hist=[],aiOn=false;
let capW=[],capB=[],cast={wK:1,wQ:1,bK:1,bQ:1},epT=null,pendPromo=null;
let gMode='vsAI',aiElo=1000,wT=600000,bT=600000,clk=null,undo=[],mc=0,fm=0,lastTick=0;

// ‚ïê‚ïê‚ïê CLOCK (millisecond precision, 100ms updates) ‚ïê‚ïê‚ïê
function startClk(){clearInterval(clk);lastTick=Date.now();clk=setInterval(()=>{if(gameOver)return;const now=Date.now(),dt=now-lastTick;lastTick=now;if(turn==='w'){wT=Math.max(0,wT-dt);if(!wT)endG('Time','b');}else{bT=Math.max(0,bT-dt);if(!bT)endG('Time','w');}rClk();},100);}
const fmt=ms=>{const s=Math.ceil(ms/1000),m=Math.floor(s/60),sec=s%60;return`${m}:${sec.toString().padStart(2,'0')}`;};
function rClk(){const w=document.getElementById('clock-white'),b=document.getElementById('clock-black');w.textContent=fmt(wT);b.textContent=fmt(bT);w.classList.toggle('urgent',wT<=30000&&turn==='w');b.classList.toggle('urgent',bT<=30000&&turn==='b');}

function initB(){board=Array(8).fill(0).map(()=>Array(8).fill(null));'RNBQKBNR'.split('').forEach((t,i)=>{board[0][i]='b'+t;board[7][i]='w'+t;});for(let i=0;i<8;i++){board[1][i]='bP';board[6][i]='wP';}}

function newGame(){clearInterval(clk);initB();turn='w';sel=null;vMoves=[];lastMv=null;gameOver=false;hist=[];capW=[];capB=[];undo=[];cast={wK:1,wQ:1,bK:1,bQ:1};epT=null;aiOn=false;pendPromo=null;wT=600000;bT=600000;mc=0;fm=0;closeModal();updPanel();if(sfOk&&!useFB){sf.postMessage('ucinewgame');cfgSF(aiElo);}rAll();startClk();}

function updPanel(){if(gMode==='vsAI'){document.getElementById('avatar-black').textContent='üèéÔ∏è';document.getElementById('name-black').textContent=sfOk&&!useFB?'STOCKFISH':'ENGINE';document.getElementById('rating-black').textContent='ELO '+aiElo;document.getElementById('avatar-white').textContent='üèÅ';document.getElementById('name-white').textContent='DRIVER';document.getElementById('rating-white').textContent='';}else{document.getElementById('avatar-black').textContent='‚¨õ';document.getElementById('name-black').textContent='PLAYER 2';document.getElementById('rating-black').textContent='BLACK';document.getElementById('avatar-white').textContent='‚¨ú';document.getElementById('name-white').textContent='PLAYER 1';document.getElementById('rating-white').textContent='WHITE';}}

// ‚ïê‚ïê‚ïê MOVE GENERATION ‚ïê‚ïê‚ïê
const IB=(r,c)=>r>=0&&r<8&&c>=0&&c<8;const PC=p=>p?p[0]:null;
function pMoves(row,col,b,ca=true,ep=true){const p=b[row][col];if(!p)return[];const[co,ty]=[p[0],p[1]],op=co==='w'?'b':'w',ms=[];const ad=(r,c,x={})=>{if(IB(r,c)&&PC(b[r][c])!==co)ms.push({from:[row,col],to:[r,c],...x});};const sl=(dr,dc)=>{let r=row+dr,c=col+dc;while(IB(r,c)){if(b[r][c]){if(PC(b[r][c])===op)ms.push({from:[row,col],to:[r,c]});break;}ms.push({from:[row,col],to:[r,c]});r+=dr;c+=dc;}};
if(ty==='P'){const d=co==='w'?-1:1,sr=co==='w'?6:1,pr=co==='w'?0:7;if(IB(row+d,col)&&!b[row+d][col]){ms.push({from:[row,col],to:[row+d,col],promotion:row+d===pr});if(row===sr&&!b[row+2*d][col])ms.push({from:[row,col],to:[row+2*d,col],doublePush:1});}for(const dc of[-1,1]){const nr=row+d,nc=col+dc;if(IB(nr,nc)&&b[nr][nc]&&PC(b[nr][nc])===op)ms.push({from:[row,col],to:[nr,nc],promotion:nr===pr});if(ep&&epT&&epT[0]===nr&&epT[1]===nc)ms.push({from:[row,col],to:[nr,nc],enPassant:1});}}
else if(ty==='R')[[1,0],[-1,0],[0,1],[0,-1]].forEach(([a,b])=>sl(a,b));
else if(ty==='B')[[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([a,b])=>sl(a,b));
else if(ty==='Q')[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([a,b])=>sl(a,b));
else if(ty==='N')[[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(([a,b])=>ad(row+a,col+b));
else if(ty==='K'){[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([a,b])=>ad(row+a,col+b));if(ca){const br=co==='w'?7:0;if(row===br&&col===4){if(cast[co+'K']&&!b[br][5]&&!b[br][6]&&b[br][7]===co+'R'&&!atk(br,4,op,b)&&!atk(br,5,op,b))ms.push({from:[row,col],to:[br,6],castle:'K'});if(cast[co+'Q']&&!b[br][3]&&!b[br][2]&&!b[br][1]&&b[br][0]===co+'R'&&!atk(br,4,op,b)&&!atk(br,3,op,b))ms.push({from:[row,col],to:[br,2],castle:'Q'});}}}
return ms;}
function atk(r,c,by,b){for(let i=0;i<8;i++)for(let j=0;j<8;j++)if(PC(b[i][j])===by&&pMoves(i,j,b,false,false).some(m=>m.to[0]===r&&m.to[1]===c))return true;return false;}
function fK(co,b){for(let r=0;r<8;r++)for(let c=0;c<8;c++)if(b[r][c]===co+'K')return[r,c];return null;}
function iC(co,b){const k=fK(co,b);return k?atk(k[0],k[1],co==='w'?'b':'w',b):false;}
function aM(m,b,pr=null){const n=b.map(r=>[...r]);const[fr,fc]=m.from,[tr,tc]=m.to,p=n[fr][fc],co=p[0];n[tr][tc]=p;n[fr][fc]=null;if(m.enPassant){const d=co==='w'?1:-1;n[tr+d][tc]=null;}if(m.promotion&&pr)n[tr][tc]=co+pr;if(m.castle==='K'){n[tr][5]=n[tr][7];n[tr][7]=null;}if(m.castle==='Q'){n[tr][3]=n[tr][0];n[tr][0]=null;}return n;}
function lM(r,c,b){const p=b[r][c];if(!p)return[];return pMoves(r,c,b).filter(m=>!iC(p[0],aM(m,b)));}
function aL(co,b){const ms=[];for(let r=0;r<8;r++)for(let c=0;c<8;c++)if(PC(b[r][c])===co)ms.push(...lM(r,c,b));return ms;}

// ‚ïê‚ïê‚ïê AI ENGINE ‚Äî Proper Alpha-Beta + Quiescence + Tactics ‚ïê‚ïê‚ïê
const MV={P:100,N:320,B:330,R:500,Q:900,K:20000};

// Move ordering: captures scored by MVV-LVA, promotions high, rest low
function orderMoves(ms,b){
  const scored=[];
  for(let i=0;i<ms.length;i++){
    const m=ms[i];
    let s=0;
    const vic=b[m.to[0]][m.to[1]];
    const att=b[m.from[0]][m.from[1]];
    if(vic) s=10*(MV[vic[1]]||0)-(MV[att[1]]||0)+10000;
    if(m.enPassant) s=10*MV.P-MV.P+10000;
    if(m.promotion) s+=9000;
    if(m.castle) s+=500;
    // Penalize moving piece to attacked square
    scored.push({m,s});
  }
  scored.sort((a,b)=>b.s-a.s);
  return scored.map(x=>x.m);
}

// Fast evaluation ‚Äî material + PST + hanging pieces + basic safety
function evaluate(b){
  let s=0;
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){
    const p=b[r][c];if(!p)continue;
    const co=p[0],t=p[1];
    const sign=co==='w'?1:-1;
    const tr=co==='w'?r:7-r;
    // Material + PST
    s+=sign*((VALS[t]||0)+((PST[t]||[])[tr]?.[c]||0));
  }
  return s;
}

// Is square attacked by color?
function sqAtk(r,c,by,b){
  // Pawn attacks
  const pd=by==='w'?1:-1;
  for(const dc of[-1,1]){
    const pr=r+pd,pc=c+dc;
    if(pr>=0&&pr<8&&pc>=0&&pc<8&&b[pr][pc]===by+'P')return true;
  }
  // Knight attacks
  for(const[dr,dc] of[[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]]){
    const nr=r+dr,nc=c+dc;
    if(nr>=0&&nr<8&&nc>=0&&nc<8&&b[nr][nc]===by+'N')return true;
  }
  // King attacks
  for(const[dr,dc] of[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]){
    const nr=r+dr,nc=c+dc;
    if(nr>=0&&nr<8&&nc>=0&&nc<8&&b[nr][nc]===by+'K')return true;
  }
  // Sliding: bishop/queen diagonals
  for(const[dr,dc] of[[1,1],[1,-1],[-1,1],[-1,-1]]){
    let nr=r+dr,nc=c+dc;
    while(nr>=0&&nr<8&&nc>=0&&nc<8){
      const q=b[nr][nc];
      if(q){if(q===by+'B'||q===by+'Q')return true;break;}
      nr+=dr;nc+=dc;
    }
  }
  // Sliding: rook/queen straights
  for(const[dr,dc] of[[1,0],[-1,0],[0,1],[0,-1]]){
    let nr=r+dr,nc=c+dc;
    while(nr>=0&&nr<8&&nc>=0&&nc<8){
      const q=b[nr][nc];
      if(q){if(q===by+'R'||q===by+'Q')return true;break;}
      nr+=dr;nc+=dc;
    }
  }
  return false;
}

// Enhanced eval with hanging piece detection
function evalFull(b){
  let s=evaluate(b);
  // Hanging piece penalty: piece attacked by opponent and not defended
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){
    const p=b[r][c];if(!p)continue;
    const co=p[0],opp=co==='w'?'b':'w',t=p[1];
    if(t==='K')continue;
    const isAttacked=sqAtk(r,c,opp,b);
    if(isAttacked){
      const isDefended=sqAtk(r,c,co,b);
      const val=MV[t]||0;
      if(!isDefended){
        // Undefended and attacked = huge penalty
        s-=(co==='w'?1:-1)*(val*0.7);
      } else {
        // Attacked and defended: if attacker is less valuable, still a threat
        // Simplified: small penalty for being under attack
        s-=(co==='w'?1:-1)*(val*0.1);
      }
    }
  }
  return s;
}

// Quiescence: search captures until position is quiet
function qSearch(b,alpha,beta,isMax,qdepth){
  nodeCount++;
  const standing=evalFull(b);
  if(isMax){
    if(standing>=beta)return beta;
    if(standing>alpha)alpha=standing;
  }else{
    if(standing<=alpha)return alpha;
    if(standing<beta)beta=standing;
  }
  if(qdepth<=0)return standing;

  const co=isMax?'b':'w';
  const ms=aL(co,b);
  // Only captures + promotions
  const tactical=[];
  for(const m of ms){
    if(b[m.to[0]][m.to[1]]||m.enPassant||m.promotion)tactical.push(m);
  }
  const sorted=orderMoves(tactical,b);

  if(isMax){
    for(const m of sorted){
      const nb=aM(m,b,m.promotion?'Q':null);
      const v=qSearch(nb,alpha,beta,false,qdepth-1);
      if(v>alpha)alpha=v;
      if(alpha>=beta)return beta;
    }
    return alpha;
  }else{
    for(const m of sorted){
      const nb=aM(m,b,m.promotion?'Q':null);
      const v=qSearch(nb,alpha,beta,true,qdepth-1);
      if(v<beta)beta=v;
      if(beta<=alpha)return alpha;
    }
    return beta;
  }
}

// Main alpha-beta search
function abSearch(b,depth,alpha,beta,isMax){
  nodeCount++;
  if(nodeCount>=MAX_NODES)return evaluate(b);
  const co=isMax?'b':'w';
  const ms=aL(co,b);

  if(!ms.length){
    if(iC(co,b))return isMax?(-100000-depth):(100000+depth);
    return 0; // stalemate
  }
  if(depth<=0)return qSearch(b,alpha,beta,isMax,6);

  const sorted=orderMoves(ms,b);

  if(isMax){
    let best=-Infinity;
    for(const m of sorted){
      const nb=aM(m,b,m.promotion?'Q':null);
      const v=abSearch(nb,depth-1,alpha,beta,false);
      if(v>best)best=v;
      if(v>alpha)alpha=v;
      if(alpha>=beta)break;
    }
    return best;
  }else{
    let best=Infinity;
    for(const m of sorted){
      const nb=aM(m,b,m.promotion?'Q':null);
      const v=abSearch(nb,depth-1,alpha,beta,true);
      if(v<best)best=v;
      if(v<beta)beta=v;
      if(beta<=alpha)break;
    }
    return best;
  }
}

function getDepth(){
  if(aiElo<=300)return 2;if(aiElo<=600)return 3;if(aiElo<=1000)return 3;
  if(aiElo<=1500)return 4;return 5;
}
function getNoise(){
  if(aiElo<=200)return 80;if(aiElo<=400)return 60;if(aiElo<=600)return 45;
  if(aiElo<=800)return 30;if(aiElo<=1000)return 18;if(aiElo<=1200)return 8;
  if(aiElo<=1500)return 3;return 0;
}
function getBlunder(){
  if(aiElo<=200)return .35;if(aiElo<=400)return .25;if(aiElo<=600)return .18;
  if(aiElo<=800)return .12;if(aiElo<=1000)return .06;if(aiElo<=1200)return .03;
  if(aiElo<=1500)return .01;return 0;
}

let nodeCount=0;const MAX_NODES=100000;

function fbAI(){
  const ms=aL('b',board);if(!ms.length)return null;
  const dep=getDepth(),noise=getNoise(),blun=getBlunder();
  const sorted=orderMoves(ms,board);
  nodeCount=0;

  // Score all moves (with node limit safety)
  let scored=sorted.map(m=>{
    const nb=aM(m,board,m.promotion?'Q':null);
    const s=(nodeCount<MAX_NODES)?abSearch(nb,dep-1,-Infinity,Infinity,false)+(Math.random()-0.5)*noise:evaluate(nb)+(Math.random()-0.5)*noise;
    return{m,s};
  });
  scored.sort((a,b)=>b.s-a.s);

  // Blunder: occasionally pick non-best (but never a move that loses major material at low depth)
  if(Math.random()<blun&&scored.length>2){
    // Only blunder among top half of moves, never pick the worst
    const pool=Math.min(Math.ceil(scored.length/2),4);
    const i=1+Math.floor(Math.random()*pool);
    if(i<scored.length)return scored[i].m;
  }
  return scored[0].m;
}

// ‚ïê‚ïê‚ïê CLICK ‚ïê‚ïê‚ïê
function handleClick(row,col){
  if(gameOver||aiOn||animating)return;if(gMode==='vsAI'&&turn==='b')return;
  const piece=board[row][col];
  if(sel){const m=vMoves.find(v=>v.to[0]===row&&v.to[1]===col);if(m){if(m.promotion){pendPromo=m;showPromo(turn);return;}doMove(m);return;}if(PC(piece)===turn){sel=[row,col];vMoves=lM(row,col,board);rBoard();return;}sel=null;vMoves=[];rBoard();return;}
  if(piece&&PC(piece)===turn){sel=[row,col];vMoves=lM(row,col,board);rBoard();}
}

// ‚ïê‚ïê‚ïê ANIMATION ‚ïê‚ïê‚ïê
let animating=false;
function animateMove(m,piece,cb){
  const bEl=document.getElementById('board');
  const bRect=bEl.getBoundingClientRect();
  const sqW=bRect.width/8,sqH=bRect.height/8;
  const fv=flipped?7-m.from[1]:m.from[1],fr=flipped?7-m.from[0]:m.from[0];
  const tv=flipped?7-m.to[1]:m.to[1],tr=flipped?7-m.to[0]:m.to[0];
  const clone=document.createElement('div');
  clone.className='anim-piece';
  clone.innerHTML=SVG[piece];
  clone.style.width=sqW*0.82+'px';clone.style.height=sqH*0.82+'px';
  clone.style.left=(bRect.left+fv*sqW+sqW*0.09)+'px';
  clone.style.top=(bRect.top+fr*sqH+sqH*0.09)+'px';
  clone.style.position='fixed';
  document.body.appendChild(clone);
  animating=true;
  requestAnimationFrame(()=>{requestAnimationFrame(()=>{
    clone.style.left=(bRect.left+tv*sqW+sqW*0.09)+'px';
    clone.style.top=(bRect.top+tr*sqH+sqH*0.09)+'px';
  });});
  setTimeout(()=>{clone.remove();animating=false;cb();},200);
}

// ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê
function rBoard(skipSquare){const el=document.getElementById('board');el.innerHTML='';const F='abcdefgh';
for(let row=0;row<8;row++)for(let col=0;col<8;col++){const dr=flipped?7-row:row,dc=flipped?7-col:col;const sq=document.createElement('div');const lt=(row+col)%2===0;sq.className='square '+(lt?'light':'dark');
if(sel&&sel[0]===dr&&sel[1]===dc)sq.classList.add('selected');if(lastMv&&((lastMv.from[0]===dr&&lastMv.from[1]===dc)||(lastMv.to[0]===dr&&lastMv.to[1]===dc)))sq.classList.add('last-move');const kp=fK(turn,board);if(iC(turn,board)&&kp&&kp[0]===dr&&kp[1]===dc)sq.classList.add('check-king');
if(col===0){const l=document.createElement('span');l.className='rank-label';l.textContent=flipped?row+1:8-row;sq.appendChild(l);}if(row===7){const l=document.createElement('span');l.className='file-label';l.textContent=F[flipped?7-col:col];sq.appendChild(l);}
if(vMoves.some(m=>m.to[0]===dr&&m.to[1]===dc)){const cap=board[dr][dc]||vMoves.find(m=>m.to[0]===dr&&m.to[1]===dc)?.enPassant;const ind=document.createElement('div');ind.className=cap?'move-ring':'move-dot';sq.appendChild(ind);}
const p=board[dr][dc];const hideThis=skipSquare&&skipSquare[0]===dr&&skipSquare[1]===dc;if(p&&!hideThis){const pe=document.createElement('div');pe.className='piece';pe.innerHTML=SVG[p];sq.appendChild(pe);}sq.addEventListener('click',()=>handleClick(dr,dc));el.appendChild(sq);}
document.getElementById('panel-white').classList.toggle('active',turn==='w');document.getElementById('panel-black').classList.toggle('active',turn==='b');}

function rCap(){const mk=p=>`<span class="cap-piece">${SVG[p]||''}</span>`;document.getElementById('captures-white').innerHTML=capW.map(mk).join('');document.getElementById('captures-black').innerHTML=capB.map(mk).join('');}
function rHist(){const el=document.getElementById('move-history');el.innerHTML='';for(let i=0;i<hist.length;i+=2){const c=document.createElement('div');c.className='move-chip'+(i>=hist.length-2?' latest':'');c.textContent=`${Math.floor(i/2)+1}. ${hist[i]}${hist[i+1]?' '+hist[i+1]:''}`;el.appendChild(c);}el.scrollLeft=el.scrollWidth;}
function rStat(){const bar=document.getElementById('status-bar');if(gameOver)return;const eng=sfOk&&!useFB?'Stockfish':'Engine';if(aiOn){bar.innerHTML=`<div class="status-badge thinking">‚è± ${eng} thinking...</div>`;return;}if(iC(turn,board)){bar.innerHTML='<div class="status-badge check">‚ö† CHECK!</div>';return;}const n=turn==='w'?(gMode==='vsAI'?'Driver':'Player 1'):(gMode==='vsAI'?eng:'Player 2');bar.innerHTML=`<div class="status-text">Lights green ‚Äî ${n} to move</div>`;}
function rAll(){rBoard();rClk();rCap();rHist();rStat();}

// ‚ïê‚ïê‚ïê MAKE MOVE ‚ïê‚ïê‚ïê
function doMove(m,pr=null){
  undo.push({board:board.map(r=>[...r]),turn,lastMv,cast:{...cast},epT,capW:[...capW],capB:[...capB],hist:[...hist],wT,bT,mc,fm});
  const[fr,fc]=m.from,[tr,tc]=m.to,piece=board[fr][fc],co=piece[0],ty=piece[1],cap=board[tr][tc];
  if(cap)(co==='w'?capW:capB).push(cap);if(m.enPassant){const d=co==='w'?1:-1;(co==='w'?capW:capB).push(board[tr+d][tc]);}
  if(ty==='K'){cast[co+'K']=0;cast[co+'Q']=0;}if(ty==='R'){if(fr===7&&fc===0)cast.wQ=0;if(fr===7&&fc===7)cast.wK=0;if(fr===0&&fc===0)cast.bQ=0;if(fr===0&&fc===7)cast.bK=0;}
  if(cap&&cap[1]==='R'){if(tr===0&&tc===0)cast.bQ=0;if(tr===0&&tc===7)cast.bK=0;if(tr===7&&tc===0)cast.wQ=0;if(tr===7&&tc===7)cast.wK=0;}
  fm=(ty==='P'||cap||m.enPassant)?0:fm+1;epT=m.doublePush?[co==='w'?tr+1:tr-1,tc]:null;

  // Animate then apply
  const finishMove=()=>{
    board=aM(m,board,pr);hist.push(mNote(m,piece,cap,pr));lastMv=m;turn=turn==='w'?'b':'w';sel=null;vMoves=[];mc++;rAll();
    const op=turn,opMs=aL(op,board);
    if(!opMs.length){if(iC(op,board))setTimeout(()=>endG('Checkmate',op==='w'?'b':'w'),400);else setTimeout(()=>endG('Stalemate',null),400);return;}
    if(gMode==='vsAI'&&turn==='b'&&!gameOver){aiOn=true;rStat();
      if(sfOk&&!useFB){
        askSF(toFEN()).then(u=>{
          if(u&&!gameOver){const mv=uci2mv(u);if(mv){const p=mv._pr||null;delete mv._pr;doMove(mv,p);}else{const fb=fbAI();if(fb)doMove(fb,fb.promotion?'Q':null);}}
          aiOn=false;rStat();
        });
      }else{
        setTimeout(()=>{const ai=fbAI();if(ai)doMove(ai,ai.promotion?'Q':null);aiOn=false;rStat();},200+Math.random()*400);
      }
    }
  };

  // Hide piece at source, show animation clone sliding to destination
  rBoard(m.from);
  animateMove(m,piece,finishMove);
}

function undoMove(){if(!undo.length||aiOn)return;if(gMode==='vsAI'&&undo.length>=2){undo.pop();const s=undo.pop();board=s.board;turn=s.turn;lastMv=s.lastMv;cast=s.cast;epT=s.epT;capW=s.capW;capB=s.capB;hist=s.hist;wT=s.wT;bT=s.bT;mc=s.mc;fm=s.fm;}else{const s=undo.pop();board=s.board;turn=s.turn;lastMv=s.lastMv;cast=s.cast;epT=s.epT;capW=s.capW;capB=s.capB;hist=s.hist;wT=s.wT;bT=s.bT;mc=s.mc;fm=s.fm;}sel=null;vMoves=[];gameOver=false;rAll();}

function mNote(m,piece,cap,pr){const F='abcdefgh',R='87654321',[fr,fc]=m.from,[tr,tc]=m.to,t=piece[1];if(m.castle)return m.castle==='K'?'O-O':'O-O-O';let n='';if(t!=='P')n+=t;if(cap||m.enPassant){if(t==='P')n+=F[fc];n+='x';}n+=F[tc]+R[tr];if(pr)n+='='+pr;return n;}

// ‚ïê‚ïê‚ïê GAME END ‚ïê‚ïê‚ïê
function endG(reason,winner){gameOver=true;clearInterval(clk);if(sf)sf.postMessage('stop');let icon,title,sub;
if(reason==='Checkmate'){icon=winner==='w'?'üèÜ':'üèéÔ∏è';title='CHECKMATE!';sub=(winner==='w'?'White':'Black')+' wins the Grand Prix';}
else if(reason==='Stalemate'){icon='ü§ù';title='STALEMATE';sub='Race ends in a draw';}
else{icon='‚è±';title='TIME OUT!';sub=(winner==='w'?'White':'Black')+' wins on time';}
document.getElementById('status-bar').innerHTML=`<div class="status-badge">${title}</div>`;
showModal(icon,title,sub,[{label:'üèÅ New Race',primary:true,action:'newGame()'},{label:'Close',action:'closeModal()'}]);}

function showPromo(co){document.getElementById('modal-icon').textContent='üëë';document.getElementById('modal-title').textContent='PIT STOP';document.getElementById('modal-sub').textContent='Promote your pawn';document.getElementById('modal-btns').innerHTML='<div class="promo-pieces">'+['Q','R','B','N'].map(t=>`<div class="promo-piece" onclick="doPr('${t}')">${SVG[co+t]}</div>`).join('')+'</div>';document.getElementById('modal-overlay').style.display='flex';}
function doPr(t){closeModal();if(pendPromo){doMove(pendPromo,t);pendPromo=null;}}
function showModal(i,t,s,btns){document.getElementById('modal-icon').textContent=i;document.getElementById('modal-title').textContent=t;document.getElementById('modal-sub').textContent=s;document.getElementById('modal-btns').innerHTML=btns.map(b=>`<button class="modal-btn ${b.primary?'primary':'secondary'}" onclick="${b.action}">${b.label}</button>`).join('');document.getElementById('modal-overlay').style.display='flex';}
function closeModal(){document.getElementById('modal-overlay').style.display='none';}

// ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
let tM=null,tE=null;
function dialTrackSVG(){
  const cx=100,cy=100,r=80,toRad=d=>d*Math.PI/180;
  const ts=toRad(210),te=toRad(-30);
  const tsx=cx+r*Math.cos(ts),tsy=cy-r*Math.sin(ts);
  const tex=cx+r*Math.cos(te),tey=cy-r*Math.sin(te);
  let s=`<svg viewBox="0 0 200 130" xmlns="http://www.w3.org/2000/svg">`;
  s+=`<defs><linearGradient id="dg" x1="0%" y1="50%" x2="100%" y2="50%"><stop offset="0%" stop-color="#00E676"/><stop offset="40%" stop-color="#D4AF37"/><stop offset="100%" stop-color="#FF4444"/></linearGradient></defs>`;
  s+=`<path d="M ${tsx} ${tsy} A ${r} ${r} 0 1 1 ${tex} ${tey}" fill="none" stroke="#222" stroke-width="16" stroke-linecap="round"/>`;
  s+=`<path id="dial-fill" d="" fill="none" stroke="url(#dg)" stroke-width="16" stroke-linecap="round"/>`;
  for(let i=0;i<=10;i++){const td=210-i*24,ta=toRad(td);
    const x1=cx+(r+12)*Math.cos(ta),y1=cy-(r+12)*Math.sin(ta);
    const x2=cx+(r+4)*Math.cos(ta),y2=cy-(r+4)*Math.sin(ta);
    s+=`<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#444" stroke-width="1.5"/>`;}
  s+=`</svg>`;return s;
}
function updDialFast(){
  const v=tE||aiElo;
  const pct=Math.max(0,Math.min(1,(v-100)/2900));
  const ang=210-pct*240;
  const cssRot=-(ang-90);
  const needle=document.getElementById('dial-needle');
  if(needle)needle.style.transform=`rotate(${cssRot}deg)`;
  const fill=document.getElementById('dial-fill');
  if(fill){
    const cx=100,cy=100,r=80,toRad=d=>d*Math.PI/180;
    const tsx=cx+r*Math.cos(toRad(210)),tsy=cy-r*Math.sin(toRad(210));
    if(pct<0.005){fill.setAttribute('d','');}
    else{const va=toRad(ang),vx=cx+r*Math.cos(va),vy=cy-r*Math.sin(va);
      fill.setAttribute('d',`M ${tsx} ${tsy} A ${r} ${r} 0 ${pct*240>180?1:0} 1 ${vx} ${vy}`);}
  }
  const d=document.getElementById('dial-value');if(d)d.textContent=v;
  const l=document.getElementById('dial-skill');
  if(l){let sk='BEGINNER';if(v>=500)sk='NOVICE';if(v>=800)sk='CLUB';if(v>=1100)sk='INTERMEDIATE';if(v>=1500)sk='ADVANCED';if(v>=2000)sk='EXPERT';if(v>=2500)sk='MASTER';l.textContent=sk;}
}
let dialDragging=false;
function initDialTouch(){
  const el=document.getElementById('dial-gauge');if(!el)return;
  const getElo=(e)=>{
    const rect=el.getBoundingClientRect();
    const cx=rect.left+rect.width/2,cy=rect.top+rect.height*(100/130);
    const px=(e.touches?e.touches[0].clientX:e.clientX);
    const py=(e.touches?e.touches[0].clientY:e.clientY);
    let ang=Math.atan2(cy-py,px-cx)*180/Math.PI;
    if(ang<-30)ang=-30;if(ang>210)ang=210;
    let elo=100+((210-ang)/240)*2900;
    return Math.max(100,Math.min(3000,Math.round(elo/50)*50));
  };
  const onStart=(e)=>{e.preventDefault();dialDragging=true;tE=getElo(e);updDialFast();};
  const onMove=(e)=>{if(!dialDragging)return;e.preventDefault();tE=getElo(e);updDialFast();};
  const onEnd=()=>{dialDragging=false;};
  el.addEventListener('mousedown',onStart);
  window.addEventListener('mousemove',onMove);
  window.addEventListener('mouseup',onEnd);
  el.addEventListener('touchstart',onStart,{passive:false});
  window.addEventListener('touchmove',onMove,{passive:false});
  window.addEventListener('touchend',onEnd);
}
function adjElo(d){tE=Math.min(3000,Math.max(100,(tE||aiElo)+d*50));updDialFast();}
function showSettings(){document.getElementById('modal-icon').textContent='‚öôÔ∏è';document.getElementById('modal-title').textContent='PIT WALL';document.getElementById('modal-sub').textContent='Configure your race';tE=aiElo;
document.getElementById('modal-btns').innerHTML=`<div class="setting-group"><div class="setting-label">Race Mode</div><div class="mode-row"><div class="mode-btn ${gMode==='vsAI'?'active':''}" onclick="selMode('vsAI')"><span class="mode-icon">üèéÔ∏è</span>VS ${sfOk&&!useFB?'STOCKFISH':'ENGINE'}</div><div class="mode-btn ${gMode==='2player'?'active':''}" onclick="selMode('2player')"><span class="mode-icon">üë•</span>2 DRIVERS</div></div></div><div class="setting-group" id="elo-section"><div class="setting-label">${sfOk&&!useFB?'Stockfish':'Engine'} Difficulty</div><div class="dial-wrap"><div class="dial-gauge" id="dial-gauge"><div class="dial-track">${dialTrackSVG()}</div><div class="dial-needle" id="dial-needle"><div class="dial-knob"></div></div><div class="dial-hub"></div></div><div class="dial-value" id="dial-value">${aiElo}</div><div class="dial-label" id="dial-skill"></div><div class="dial-controls"><div class="dial-btn" onclick="adjElo(-1)">‚àí</div><div style="font-family:Orbitron,monospace;font-size:9px;color:#555;letter-spacing:2px">ELO</div><div class="dial-btn" onclick="adjElo(1)">+</div></div><div class="dial-range"><span>100</span><span>3000</span></div><div class="dial-hint">drag to set ¬∑ tap ¬± to fine tune</div></div></div><button class="modal-btn primary" onclick="applyS()" style="margin-top:8px">üèÅ START RACE</button><button class="modal-btn secondary" onclick="closeModal()">Cancel</button>`;
document.getElementById('modal-overlay').style.display='flex';updEloVis();updDialFast();setTimeout(initDialTouch,50);}
function selMode(m){tM=m;document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));event.currentTarget.classList.add('active');updEloVis();}
function selElo(e){tE=e;}
function updEloVis(){const s=document.getElementById('elo-section');if(s)s.style.display=(tM||gMode)==='2player'?'none':'block';}
function applyS(){if(tM)gMode=tM;if(tE)aiElo=tE;tM=null;tE=null;newGame();}
function flipBoard(){flipped=!flipped;rBoard();}

// ‚ïê‚ïê‚ïê PGN PARSER & REPLAY ‚ïê‚ïê‚ïê
let replayMode=false,replayMoves=[],replayIdx=0,replayPositions=[],replayHeaders={},autoPlayTimer=null;

function parsePGN(pgn){
  // Extract headers
  const headers={};
  pgn.replace(/\[(\w+)\s+"([^"]*)"\]/g,(m,k,v)=>{headers[k]=v;});
  // Extract moves - strip headers, comments, variations, result
  let moveText=pgn.replace(/\[.*?\]\s*/g,'').replace(/\{[^}]*\}/g,'').replace(/\([^)]*\)/g,'');
  moveText=moveText.replace(/\d+\.\.\./g,'').replace(/\d+\./g,' ').replace(/(1-0|0-1|1\/2-1\/2|\*)/g,'').trim();
  const tokens=moveText.split(/\s+/).filter(t=>t.length>0&&!t.match(/^[\d.]+$/));
  return{headers,moves:tokens};
}

function sanToMove(san,color,b){
  // Parse SAN notation and find matching legal move
  let s=san.replace(/[+#!?]/g,'');
  // Castling
  if(s==='O-O'||s==='0-0'){
    const r=color==='w'?7:0;
    const ms=lM(r,4,b);
    return ms.find(m=>m.castle==='K')||null;
  }
  if(s==='O-O-O'||s==='0-0-0'){
    const r=color==='w'?7:0;
    const ms=lM(r,4,b);
    return ms.find(m=>m.castle==='Q')||null;
  }
  let promo=null;
  if(s.includes('=')){promo=s.split('=')[1][0];s=s.split('=')[0];}
  const isCapture=s.includes('x');
  s=s.replace('x','');
  const F='abcdefgh';
  // Destination square is always last 2 chars
  const destFile=F.indexOf(s[s.length-2]);
  const destRank=8-parseInt(s[s.length-1]);
  if(destFile<0||destRank<0||destRank>7)return null;
  s=s.slice(0,-2);
  // Determine piece type
  let pieceType='P';
  if(s.length>0&&s[0]>='A'&&s[0]<='Z'){pieceType=s[0];s=s.slice(1);}
  // Disambiguation
  let disambigFile=-1,disambigRank=-1;
  if(s.length===2){disambigFile=F.indexOf(s[0]);disambigRank=8-parseInt(s[1]);}
  else if(s.length===1){if(s[0]>='a'&&s[0]<='h')disambigFile=F.indexOf(s[0]);else disambigRank=8-parseInt(s[0]);}
  // Find matching legal move
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){
    const p=b[r][c];
    if(!p||p[0]!==color||p[1]!==pieceType)continue;
    if(disambigFile>=0&&c!==disambigFile)continue;
    if(disambigRank>=0&&r!==disambigRank)continue;
    const ms=lM(r,c,b);
    for(const m of ms){
      if(m.to[0]===destRank&&m.to[1]===destFile){
        if(promo)return{...m,promotion:true,_pr:promo};
        return m;
      }
    }
  }
  return null;
}

function buildReplayPositions(moves){
  initB();
  const positions=[board.map(r=>[...r])];
  const castState=[{...cast}];
  const epState=[epT];
  let curBoard=board.map(r=>[...r]);
  let curCast={wK:1,wQ:1,bK:1,bQ:1};
  let curEp=null;
  let curTurn='w';
  const parsed=[];
  cast={...curCast};epT=curEp;
  for(let i=0;i<moves.length;i++){
    board=curBoard.map(r=>[...r]);
    cast={...curCast};epT=curEp;
    const mv=sanToMove(moves[i],curTurn,board);
    if(!mv){parsed.push(null);break;}
    const piece=board[mv.from[0]][mv.from[1]];
    const ty=piece[1],co=piece[0];
    // Update castling
    if(ty==='K'){curCast[co+'K']=0;curCast[co+'Q']=0;}
    if(ty==='R'){const[fr,fc]=mv.from;if(fr===7&&fc===0)curCast.wQ=0;if(fr===7&&fc===7)curCast.wK=0;if(fr===0&&fc===0)curCast.bQ=0;if(fr===0&&fc===7)curCast.bK=0;}
    const cap=board[mv.to[0]][mv.to[1]];
    if(cap&&cap[1]==='R'){const[tr,tc]=mv.to;if(tr===0&&tc===0)curCast.bQ=0;if(tr===0&&tc===7)curCast.bK=0;if(tr===7&&tc===0)curCast.wQ=0;if(tr===7&&tc===7)curCast.wK=0;}
    curEp=mv.doublePush?[co==='w'?mv.to[0]+1:mv.to[0]-1,mv.to[1]]:null;
    const pr=mv._pr||null;
    curBoard=aM(mv,board,pr);
    positions.push(curBoard.map(r=>[...r]));
    parsed.push(moves[i]);
    curTurn=curTurn==='w'?'b':'w';
    cast={...curCast};epT=curEp;
  }
  return{positions,parsed};
}

function enterReplay(pgn){
  const{headers,moves}=parsePGN(pgn);
  if(!moves.length){alert('No moves found in PGN');return;}
  const{positions,parsed}=buildReplayPositions(moves);
  replayHeaders=headers;
  replayMoves=parsed.filter(m=>m!==null);
  replayPositions=positions;
  replayIdx=0;
  replayMode=true;
  // Hide game UI, show replay UI
  document.getElementById('game-controls').style.display='none';
  document.getElementById('replay-bar').style.display='flex';
  document.getElementById('status-bar').style.display='none';
  clearInterval(clk);
  // Show header info
  const w=headers.White||'?';const bl=headers.Black||'?';
  const ev=headers.Event||'';const dt=headers.Date||'';const res=headers.Result||'';
  document.getElementById('replay-info').textContent=`${w} vs ${bl}${ev?' ¬∑ '+ev:''}${dt?' ¬∑ '+dt:''}${res?' ¬∑ '+res:''}`;
  document.getElementById('name-white').textContent=w;
  document.getElementById('name-black').textContent=bl;
  document.getElementById('rating-white').textContent=headers.WhiteElo||'';
  document.getElementById('rating-black').textContent=headers.BlackElo||'';
  document.getElementById('avatar-white').textContent='‚¨ú';
  document.getElementById('avatar-black').textContent='‚¨õ';
  document.getElementById('clock-white').style.display='none';
  document.getElementById('clock-black').style.display='none';
  replayRender();
  closeModal();
}

function replayRender(){
  board=replayPositions[replayIdx].map(r=>[...r]);
  turn=replayIdx%2===0?'w':'b';
  lastMv=null;sel=null;vMoves=[];
  rBoard();
  // Move label
  const lbl=document.getElementById('replay-move-label');
  if(replayIdx===0)lbl.textContent='Start Position';
  else{
    const mn=Math.ceil(replayIdx/2);
    const side=replayIdx%2===1?'White':'Black';
    lbl.textContent=`Move ${mn}. ${replayMoves[replayIdx-1]} (${side})`;
  }
  // Update move chips
  const el=document.getElementById('move-history');el.innerHTML='';
  for(let i=0;i<replayMoves.length;i+=2){
    const c=document.createElement('div');
    c.className='move-chip'+(i+1===replayIdx||i+2===replayIdx?' latest':'');
    c.textContent=`${Math.floor(i/2)+1}. ${replayMoves[i]}${replayMoves[i+1]?' '+replayMoves[i+1]:''}`;
    const idx=i;
    c.onclick=()=>{replayIdx=idx+1;replayRender();};
    el.appendChild(c);
  }
  el.scrollLeft=el.scrollWidth;
}

function replayStep(dir){
  if(autoPlayTimer){clearInterval(autoPlayTimer);autoPlayTimer=null;document.getElementById('replay-auto-btn').classList.remove('active');}
  replayIdx=Math.max(0,Math.min(replayPositions.length-1,replayIdx+dir));
  replayRender();
}
function replayGo(pos){
  if(autoPlayTimer){clearInterval(autoPlayTimer);autoPlayTimer=null;document.getElementById('replay-auto-btn').classList.remove('active');}
  replayIdx=Math.max(0,Math.min(replayPositions.length-1,pos));
  replayRender();
}
function replayToggleAuto(){
  if(autoPlayTimer){clearInterval(autoPlayTimer);autoPlayTimer=null;document.getElementById('replay-auto-btn').classList.remove('active');return;}
  document.getElementById('replay-auto-btn').classList.add('active');
  autoPlayTimer=setInterval(()=>{
    if(replayIdx>=replayPositions.length-1){clearInterval(autoPlayTimer);autoPlayTimer=null;document.getElementById('replay-auto-btn').classList.remove('active');return;}
    replayIdx++;replayRender();
  },1200);
}
function exitReplay(){
  if(autoPlayTimer){clearInterval(autoPlayTimer);autoPlayTimer=null;}
  replayMode=false;
  document.getElementById('game-controls').style.display='flex';
  document.getElementById('replay-bar').style.display='none';
  document.getElementById('status-bar').style.display='flex';
  document.getElementById('clock-white').style.display='';
  document.getElementById('clock-black').style.display='';
  newGame();
}

function showPGNUpload(){
  document.getElementById('modal-icon').textContent='üìã';
  document.getElementById('modal-title').textContent='REPLAY';
  document.getElementById('modal-sub').textContent='Load a PGN game';
  document.getElementById('modal-btns').innerHTML=`
    <textarea class="pgn-textarea" id="pgn-input" placeholder="Paste PGN here...&#10;&#10;1. e4 e5 2. Nf3 Nc6 3. Bb5 a6..."></textarea>

```
<button class="modal-btn primary" onclick="loadPGNFromText()">üèÅ LOAD GAME</button>
<div class="pgn-or">‚Äî or ‚Äî</div>
<label class="pgn-file-btn" for="pgn-file-input">üìÅ Upload .pgn file</label>
<input type="file" id="pgn-file-input" accept="*/*" style="display:none" onchange="loadPGNFromFile(event)">
<button class="modal-btn secondary" onclick="closeModal()" style="margin-top:6px">Cancel</button>`;
```

document.getElementById(‚Äòmodal-overlay‚Äô).style.display=‚Äòflex‚Äô;
}
function loadPGNFromText(){
const txt=document.getElementById(‚Äòpgn-input‚Äô).value.trim();
if(!txt)return;
enterReplay(txt);
}
function loadPGNFromFile(e){
const file=e.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=(ev)=>{enterReplay(ev.target.result);};
reader.readAsText(file);
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
try{newGame();}catch(e){document.getElementById(‚Äòboard‚Äô).innerHTML=‚Äô<div style="grid-column:1/-1;grid-row:1/-1;color:red;display:flex;align-items:center;justify-content:center;font-size:14px;padding:20px;text-align:center">Board Error: ‚Äò+e.message+‚Äô</div>‚Äô;}
// Load Stockfish AFTER board is rendered
setTimeout(function(){try{initSF();}catch(e){console.error(‚ÄòinitSF error:‚Äô,e);}},500);
// Safety: if board still empty after 3s, force re-render
setTimeout(function(){var b=document.getElementById(‚Äòboard‚Äô);if(b&&b.children.length===0){try{newGame();}catch(e){b.innerHTML=‚Äô<div style="color:red;padding:20px;grid-column:1/-1">Retry Error: ‚Äò+e.message+‚Äô</div>‚Äô;}}},3000);
</script>

</body>
</html>